# 표지판 자동 인식 및 동작 가이드
## 📅 2024-11-13

## 🚦 표지판별 자동 동작 매트릭스

### ✅ 구현된 표지판 동작

| 표지판 | 감지 시 동작 | 실행 타이밍 | 동작 시간 | 쿨다운 |
|--------|------------|------------|----------|---------|
| 🛑 **STOP** | 즉시 정지 | 즉시 실행 | 2초 정지 | 3초 |
| ⚠️ **SLOW** | 속도 감소 | 즉시 실행 | 3초 감속 | 자동 |
| 📢 **HORN** | 경적 울림 | 즉시 실행 | 1초 | 없음 |
| 🚦 **신호등** | 정지 후 우회전 | 즉시 실행 | 3초 대기 + 1초 회전 | 5초 |
| ⬆️ **직진** | 큐 저장 | 교차로에서 | 1.5초 | 3초 |
| ⬅️ **좌회전** | 큐 저장 | 교차로에서 | 1초 회전 | 3초 |
| ➡️ **우회전** | 큐 저장 | 교차로에서 | 1초 회전 | 3초 |

## 🔄 동작 시나리오별 설명

### 1. 🛑 STOP 표지판 감지 시
```
1. STOP 표지판 감지
   ↓
2. 즉시 차량 정지 (motor_stop())
   ↓
3. 2초 대기
   ↓
4. 천천히 출발 (SPEED_SLOW_FORWARD)
   ↓
5. 3초 쿨다운 (중복 정지 방지)
```

**코드 동작:**
```python
# lane_tracer.py (line 246-273)
if obj_state.get("stop"):
    motor_stop()           # 즉시 정지
    time.sleep(2.0)       # 2초 대기
    motor_forward(SPEED_SLOW_FORWARD)  # 천천히 출발
```

### 2. ⚠️ SLOW 표지판 감지 시
```
1. SLOW 표지판 감지
   ↓
2. 속도를 즉시 감속 (set_slow_mode())
   ↓
3. 3초간 저속 유지
   ↓
4. 자동으로 정상 속도 복구
```

**속도 변경:**
- 정상 속도: `SPEED_DEFAULT = 0.85`
- 감속 속도: `SPEED_SLOW_FORWARD = 0.60`

### 3. 📢 HORN 표지판 감지 시
```
1. HORN 표지판 감지
   ↓
2. 부저 활성화 (GPIO 12번)
   ↓
3. 1초 경적
   ↓
4. 부저 비활성화
```

**하드웨어 연결:**
- GPIO 12번 핀 → 부저
- 부저가 없으면 콘솔에 시뮬레이션 메시지 출력

### 4. 🚦 신호등 감지 시
```
1. 신호등 감지
   ↓
2. 즉시 차량 정지
   ↓
3. 3초 신호 대기
   ↓
4. 우회전 실행 (1초)
   ↓
5. 천천히 출발
   ↓
6. 5초 쿨다운
```

**동작 이유:** 신호등에서는 보통 우회전이 안전하므로 자동 우회전

### 5. 방향 표지판 (직진/좌회전/우회전)
```
1. 방향 표지판 감지
   ↓
2. 큐에 저장 (최대 5개)
   ↓
3. 교차로 도달 대기
   ↓
4. 교차로 감지 시 실행
   ↓
5. 표지판 동작 수행
```

**교차로 감지 조건:**
- 노란색 라인이 많이 감지될 때
- 양쪽 라인이 모두 감지될 때

## 📊 시스템 동작 흐름

### 전체 시스템 구조
```
카메라 (640x480)
    ↓
lane_tracer.py ← 프레임 공유 (3프레임마다) → object_detector.py
    ↓                                              ↓
라인 트레이싱                                YOLO 모델 (best.pt)
    ↓                                              ↓
모터 제어                                    객체 감지
    ↓                                              ↓
즉시 동작 (STOP/SLOW/HORN/신호등)      shared_state 업데이트
    ↓                                              ↓
교차로 동작 (방향 표지판)                     큐 저장
```

## 🎯 우선순위 및 충돌 처리

### 표지판 우선순위
1. **최우선**: STOP (즉시 정지)
2. **높음**: 신호등 (안전 우선)
3. **중간**: SLOW (속도 조절)
4. **낮음**: 방향 표지판 (교차로에서만)
5. **보조**: HORN (경적)

### 충돌 처리 규칙
- STOP과 다른 표지판이 동시에 감지되면 STOP 우선
- 신호등과 방향 표지판이 동시에 감지되면 신호등 우선
- 쿨다운 시간 내에는 같은 표지판 무시
- 교차로가 아니면 방향 표지판은 큐에만 저장

## 🔧 조정 가능한 파라미터

### 시간 설정 (lane_tracer.py)
```python
# 정지 시간
STOP_WAIT_TIME = 2.0      # STOP 표지판 정지 시간
TRAFFIC_WAIT_TIME = 3.0   # 신호등 대기 시간

# 회전 시간
TURN_DURATION = 1.0       # 회전 지속 시간 (좌/우회전)

# 쿨다운
STOP_COOLDOWN = 3.0       # STOP 표지판 쿨다운
TRAFFIC_COOLDOWN = 5.0    # 신호등 쿨다운
SIGN_COOLDOWN = 3.0       # 방향 표지판 쿨다운
```

### 속도 설정
```python
SPEED_DEFAULT = 0.85      # 기본 주행 속도
SPEED_SLOW_FORWARD = 0.60 # 감속 모드 속도
SPEED_TURN = 0.75         # 회전 속도
```

## 🐛 디버그 로그 예시

### 정상 동작 시 로그
```
🛑 [STOP 표지판 감지] 즉시 정지!
  └─ 15:30:45 | Frame #1234 | 신뢰도: 0.95
  └─ 정지 중... (2초)
  └─ 천천히 출발

⚠️ [SLOW 표지판 감지] 감속 모드 전환
  └─ 15:31:20 | Frame #2345 | 신뢰도: 0.88
  └─ SLOW 모드 자동 해제 (15:31:23)

📢 [객체인식] HORN 표지판 감지 → 경적 1초
  └─ 15:32:10 | Frame #3456 | 신뢰도: 0.92
  └─ HORN 동작 완료 (15:32:11)

🚦 [신호등 감지] 정지 후 안전 확인
  └─ 15:33:00 | Frame #4567 | 신뢰도: 0.90
  └─ 신호 대기 중... (3초)
  └─ 안전 확인 후 우회전
  └─ 우회전 완료, 천천히 출발
```

## ⚠️ 주의사항

1. **하드웨어 연결**
   - 부저: GPIO 12번 핀
   - 모터: GPIO 17, 27 (왼쪽), GPIO 22, 23 (오른쪽)
   - PWM: GPIO 18 (왼쪽), GPIO 19 (오른쪽)

2. **카메라 설정**
   - 해상도: 640x480
   - ROI: 오른쪽 절반만 스캔 (표지판 감지용)

3. **모델 파일**
   - 반드시 `best.pt` 파일이 있어야 함
   - 위치: `/home/keonha/AI_CAR/` 또는 `/home/keonha/AI_CAR/product/`

## 📝 테스트 체크리스트

### 개별 표지판 테스트
- [ ] STOP 표지판: 2초 정지 후 출발 확인
- [ ] SLOW 표지판: 3초 감속 유지 확인
- [ ] HORN 표지판: 1초 경적 확인
- [ ] 신호등: 3초 정지 후 우회전 확인
- [ ] 방향 표지판: 교차로에서 실행 확인

### 복합 시나리오 테스트
- [ ] STOP → SLOW 연속 감지
- [ ] 신호등 → 방향 표지판 연속
- [ ] 교차로 전 여러 표지판 감지
- [ ] 쿨다운 시간 내 재감지 무시 확인