# 표지판 인식 큐 시스템
## 📅 2024-11-12

### 🎯 변경 목적
기존에는 표지판을 인식하자마자 즉시 정지하고 동작을 수행했습니다. 이로 인해 주행 중 갑작스러운 정지가 발생했습니다.
이제는 표지판을 미리 인식하여 큐에 저장하고, 교차로나 정지 상황에서 저장된 표지판을 실행하도록 변경했습니다.

### 🔄 동작 방식 변경

#### 이전 방식 (즉시 실행)
```
1. 표지판 인식
2. 즉시 정지 (motor_stop())
3. 해당 동작 실행 (좌회전/우회전/직진)
4. 주행 재개
```

#### 새로운 방식 (큐 시스템)
```
1. 주행 중 표지판 인식
2. 큐에 저장 (최대 5개)
3. 계속 주행
4. 교차로 도착 시 저장된 표지판 실행
```

### ✅ 주요 변경 내용

#### 1. **표지판 인식 큐 추가**
```python
from collections import deque

# 표지판 인식 큐 시스템
recognized_signs = deque(maxlen=5)  # 최근 5개 표지판만 저장
last_sign_time = 0  # 마지막 표지판 인식 시간
SIGN_COOLDOWN = 3.0  # 동일 표지판 재인식 방지 시간
```

#### 2. **새로운 함수들**

**store_direction_signs(frame_count)**
- 방향 표지판 인식하여 큐에 저장
- 중복 방지 로직 포함
- 쿨다운 시간 체크

**execute_stored_sign()**
- 저장된 표지판 실행
- 교차로나 정지 시점에 호출
- FIFO 방식으로 순서대로 실행

#### 3. **메인 루프 수정**
```python
# 방향 표지판을 큐에 저장 (주행 중에도 계속 인식)
if OBJECT_DETECTION_ENABLED and frame_count % 5 == 0:
    store_direction_signs(frame_count)
```

#### 4. **교차로 처리 변경**
```python
# 먼저 저장된 표지판 확인하여 실행
if OBJECT_DETECTION_ENABLED and try_branch_by_trigger(frame_count):
    print("  [교차로] 저장된 표지판 → 자동 실행")
```

### 📊 개선 효과

| 항목 | 이전 | 개선 후 |
|------|------|---------|
| 주행 중 정지 | 표지판 감지 시 즉시 | 교차로에서만 |
| 인식 타이밍 | 정지 후 인식 | 주행 중 미리 인식 |
| 동작 실행 | 즉시 실행 | 교차로에서 실행 |
| 주행 안정성 | 급정지 발생 | 부드러운 주행 |

### 🔧 큐 시스템 파라미터

```python
# 큐 크기
recognized_signs = deque(maxlen=5)  # 최대 5개 저장

# 재인식 방지
SIGN_COOLDOWN = 3.0  # 3초 동안 동일 표지판 무시

# 인식 주기
frame_count % 5 == 0  # 5프레임마다 인식
```

### 💡 사용 시나리오

#### 시나리오 1: 일반 주행
```
1. 직진 표지판 감지 → 큐에 저장
2. 계속 주행
3. 교차로 도착
4. 저장된 직진 표지판 실행
```

#### 시나리오 2: 여러 표지판
```
1. 좌회전 표지판 감지 → 큐에 저장
2. 직진 표지판 감지 → 큐에 추가
3. 교차로 도착
4. 첫 번째 표지판(좌회전) 실행
```

#### 시나리오 3: 표지판 없이 교차로
```
1. 표지판 없이 교차로 도착
2. 큐가 비어있음
3. 키보드 입력 대기
```

### ⚠️ 주의사항

1. **큐 크기**: 5개로 제한되어 있으므로 오래된 표지판은 자동 삭제
2. **쿨다운**: 3초 내 동일 표지판은 무시됨
3. **실행 순서**: FIFO 방식으로 먼저 인식된 표지판부터 실행

### 🔍 디버깅 정보

표지판 인식 시 출력:
```
⬅️ [표지판 인식] 좌회전 표지판 감지 (저장됨)
  └─ 15:30:45 | Frame #150 | 신뢰도: 0.85
  └─ 큐에 2개 표지판 저장됨
```

표지판 실행 시 출력:
```
==================================================
📋 저장된 표지판 실행
==================================================
⬅️ 좌회전 표지판 → 좌회전 실행
  └─ 저장시간: 15:30:45 | 신뢰도: 0.85
  └─ 좌회전 완료
```

### 📈 향후 개선 방향

1. **우선순위 시스템**: 신뢰도 기반 우선순위 큐
2. **시간 기반 만료**: 오래된 표지판 자동 삭제
3. **표지판 조합**: 복수 표지판 패턴 인식
4. **학습 기반**: 표지판 위치 학습 및 예측