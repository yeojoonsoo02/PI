# 개선된 라인 트레이서 가이드 🚗

## 🎯 주요 개선 사항

### 1. 노란색 라인 전용 감지
```python
# HSV 색공간 사용으로 노란색 정확히 감지
lower_yellow = np.array([20, 100, 100])  # H, S, V
upper_yellow = np.array([30, 255, 255])
```

### 2. 3개 ROI 시스템
```
┌─────────────────────────────┐
│   [좌]   [중앙]   [우]      │
│    □      ■       □        │
└─────────────────────────────┘
```
- **좌측 ROI**: 왼쪽 라인 감지
- **중앙 ROI**: 트랙 중앙 라인 감지 (우선순위 높음)
- **우측 ROI**: 오른쪽 라인 감지

### 3. 개선된 제어 로직

#### 우선순위
```python
1순위: 중앙 라인 → 직진 (트랙 중앙 유지)
2순위: 좌우 균형 → 직진 또는 미세 조정
3순위: 한쪽 라인만 → 라인 안쪽으로 회전
4순위: 라인 없음 → 검색 모드
```

#### 상세 동작
| 상황 | 명령 | 동작 |
|-----|------|------|
| 중앙에 라인 있음 | `forward` | 직진 (65 속도) |
| 좌우 균형 | `forward` | 직진 유지 |
| 좌측 라인 많음 | `slight_right` | 미세 우회전 (40 속도) |
| 우측 라인 많음 | `slight_left` | 미세 좌회전 (40 속도) |
| 좌측만 라인 | `right` | 우회전 (50 속도) |
| 우측만 라인 | `left` | 좌회전 (50 속도) |
| 라인 없음 | `search` | 검색 모드 |

### 4. 라인 검색 모드
```python
라인이 안 보일 때:
1. 먼저 정지 (10프레임)
2. 마지막 방향으로 천천히 회전 (35 속도)
3. 50프레임 후에도 못 찾으면 반대 방향 시도
```

---

## 🚀 사용 방법

### 실행
```bash
python dual_roi_line_tracer_improved.py
```

### 키보드 조작
| 키 | 기능 |
|---|---|
| `q` / `ESC` | 종료 |
| `1` / `2` | H_min 조정 (노란색 최소 색상) |
| `3` / `4` | H_max 조정 (노란색 최대 색상) |
| `5` / `6` | S_min 조정 (채도 최소) |
| `7` / `8` | min_pixels 조정 (감도) |
| `s` | 현재 설정 출력 |

---

## 🎨 화면 설명

### 메인 화면
- **초록색 영역**: 감지된 노란색 라인
- **파란색 박스**: 라인이 감지된 ROI
- **빨간색 박스**: 라인이 없는 ROI
- **두꺼운 박스**: 중앙 ROI (가장 중요)

### 정보 표시
```
Command: FORWARD          ← 현재 명령
Left: 1234px             ← 좌측 라인 픽셀 수
Center: 5678px           ← 중앙 라인 픽셀 수 (중요!)
Right: 2345px            ← 우측 라인 픽셀 수
```

---

## ⚙️ 파라미터 튜닝

### 1. 노란색 범위 조정

#### 기본값
```python
H_min=20, H_max=30   # 노란색 범위
S_min=100, S_max=255 # 채도 (선명도)
V_min=100, V_max=255 # 명도 (밝기)
```

#### 조정 가이드
**문제**: 노란색이 감지 안 됨
```python
# 1/2 키로 H_min 낮추기 (20 → 15)
# 3/4 키로 H_max 높이기 (30 → 35)
```

**문제**: 배경도 감지됨
```python
# 5/6 키로 S_min 높이기 (100 → 150)
# 더 선명한 노란색만 감지
```

**문제**: 어두운 환경
```python
# V_min을 코드에서 낮추기 (100 → 50)
```

### 2. 민감도 조정

```python
# 7/8 키로 min_pixels 조정
min_pixels = 150  # 기본값

# 가는 라인: 100으로 낮춤
# 굵은 라인: 200으로 높임
```

### 3. ROI 크기 조정

코드에서 수정:
```python
roi_height_ratio = 0.4   # 화면 하단 40%
roi_width_ratio = 0.35   # 좌우 각 35%

# 좁은 트랙: 0.25로 줄임
# 넓은 트랙: 0.45로 늘림
```

---

## 🔍 기존 코드와의 차이점

### 기존 (dual_roi_line_tracer.py)
```python
❌ 검은색 선 감지 (Grayscale)
❌ 좌우 2개 ROI만
❌ 단순 ON/OFF 제어
❌ 라인 없을 때 즉시 정지
```

### 개선 (dual_roi_line_tracer_improved.py)
```python
✅ 노란색 선 감지 (HSV)
✅ 좌/중앙/우 3개 ROI
✅ 미세 조정 가능 (slight_left/right)
✅ 라인 검색 모드 (회전하며 찾기)
✅ 픽셀 수 차이로 중앙 유지
```

---

## 🐛 트러블슈팅

### 문제 1: 트랙을 벗어남
**원인**: ROI가 너무 넓거나 좁음

**해결**:
```python
# ROI 크기 조정
roi_width_ratio = 0.3  # 더 좁게
# 또는
roi_width_ratio = 0.4  # 더 넓게
```

### 문제 2: 곡선에서 못 따라감
**원인**: 회전 속도가 느림

**해결**:
```python
# motor_left/right 속도 증가
motor_left(60)   # 50 → 60
motor_right(60)  # 50 → 60
```

### 문제 3: 횡단보도에서 멈춤
**원인**: 흰색 횡단보도를 라인 없음으로 판단

**해결**:
```python
# 검색 모드 대기 시간 늘리기
if search_count < 20:  # 10 → 20
    motor_stop()
```

### 문제 4: 조명에 민감함
**원인**: V_min이 너무 높음

**해결**:
```python
# 코드에서 수정
v_min = 50  # 100 → 50
```

---

## 📊 성능 비교

| 항목 | 기존 | 개선 |
|-----|------|------|
| 라인 감지 정확도 | ⭐⭐⭐☆☆ | ⭐⭐⭐⭐⭐ |
| 트랙 중앙 유지 | ⭐⭐☆☆☆ | ⭐⭐⭐⭐☆ |
| 곡선 주행 | ⭐⭐⭐☆☆ | ⭐⭐⭐⭐☆ |
| 라인 복귀 | ⭐⭐☆☆☆ | ⭐⭐⭐⭐⭐ |
| 조명 강건성 | ⭐⭐☆☆☆ | ⭐⭐⭐⭐☆ |

---

## 💡 추가 개선 가능 사항

### 1. 속도 조절
```python
# 직선: 빠르게
if command == "forward" and center_has_line:
    motor_forward(80)

# 곡선: 느리게
elif command in ["left", "right"]:
    motor_left(40)  # 또는 motor_right(40)
```

### 2. PID 제어
```python
# 픽셀 수 차이를 에러로 사용
error = left_pixels - right_pixels
steering = pid.update(error)
# 더 부드러운 제어
```

### 3. 횡단보도 감지
```python
# 흰색 영역이 많으면 횡단보도로 판단
white_pixels = detect_white_crosswalk(frame)
if white_pixels > threshold:
    motor_forward(50)  # 천천히 통과
```

---

## 📝 사용 팁

### 1. 처음 사용 시
```bash
# 1. 테스트 모드로 실행
python dual_roi_line_tracer_improved.py

# 2. 's' 키를 눌러 현재 설정 확인
# 3. 노란색이 초록색으로 잘 표시되는지 확인
# 4. Center ROI에 라인이 감지되는지 확인 (가장 중요!)
```

### 2. 파라미터 저장
```python
# 's' 키를 눌러 출력된 값을 복사
# 코드의 401-404번 줄에 붙여넣기
h_min, h_max = 25, 32  # 찾은 값
s_min, s_max = 120, 255
v_min, v_max = 80, 255
min_pixels = 180
```

### 3. 최적 ROI 위치
```
카메라 시야각에 따라 조정:
- 넓은 시야각: roi_height_ratio = 0.3
- 좁은 시야각: roi_height_ratio = 0.5
```

---

## ✅ 체크리스트

실행 전:
- [ ] 노란색 라인이 있는 트랙인가?
- [ ] 카메라가 정면을 향하는가?
- [ ] 조명이 충분한가?

실행 중:
- [ ] Center ROI에 라인이 감지되는가?
- [ ] 초록색 오버레이가 라인과 일치하는가?
- [ ] Command가 적절히 변하는가?

문제 발생 시:
- [ ] 's' 키로 현재 설정 확인
- [ ] Binary 창에서 노란색이 흰색으로 보이는가?
- [ ] ROI 크기가 적절한가?

---

**파일명**: `dual_roi_line_tracer_improved.py`

**노란색 트랙 전용 개선 버전입니다!** 🎉
